<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Trail Weather">
<title>Trail Weather Advisor</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f4f0e8;--bgs:#ebe5d9;--card:#fffdf8;--tx:#3b3226;--txm:#6b5e4f;--txmu:#9a8e7d;--txl:#c0b6a6;--ac:#5c7a5a;--ach:#4a6848;--bd:#ddd5c8;--bdl:#ece6db;--dng:#c45a3c;--sh:0 2px 10px rgba(59,50,38,.05);--shl:0 8px 32px rgba(59,50,38,.12);--sf:'Crimson Pro',Georgia,serif;--sn:'DM Sans','Segoe UI',sans-serif}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--sn);background:var(--bg);color:var(--tx);min-height:100vh;min-height:100dvh;-webkit-font-smoothing:antialiased;line-height:1.5}
button{font-family:var(--sn);cursor:pointer;border:none;background:none}input,textarea,select{font-family:var(--sn)}
a{color:var(--ac);text-decoration:none}a:hover{text-decoration:underline}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

.hdr{background:var(--card);border-bottom:1px solid var(--bd);padding:14px 20px;position:sticky;top:0;z-index:50}
.hdr-in{max-width:960px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
.hdr-left{display:flex;align-items:center;gap:9px}
.hdr h1{font-family:var(--sf);font-size:22px;font-weight:700;letter-spacing:-.3px}
.hdr .sub{font-size:12px;color:var(--txmu);margin:1px 0 0 33px}
.gear{font-size:20px;padding:6px;border-radius:8px;opacity:.55;transition:all .15s}
.gear:hover{background:var(--bgs);opacity:1}
.mn{max-width:960px;margin:0 auto;padding:16px 16px 60px}

.swrap{position:relative;margin-bottom:12px}
.srow{display:flex;gap:8px;align-items:stretch}
.sbox{display:flex;align-items:center;gap:9px;background:var(--card);border:1.5px solid var(--bd);border-radius:12px;padding:11px 14px;box-shadow:var(--sh);transition:all .2s;flex:1}
.sbox.fo{border-color:var(--ac);box-shadow:0 0 0 3px rgba(92,122,90,.07)}
.sbox input{flex:1;border:none;outline:none;background:transparent;font-size:15px;color:var(--tx)}
.sbox input::placeholder{color:var(--txl)}
.gps-btn{background:var(--card);border:1.5px solid var(--bd);border-radius:12px;padding:0 14px;font-size:18px;transition:all .2s;display:flex;align-items:center;box-shadow:var(--sh)}
.gps-btn:hover,.gps-btn:active{border-color:var(--ac);background:rgba(92,122,90,.04)}
.gps-btn.loading{opacity:.5;cursor:wait}
.sdd{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--card);border:1px solid var(--bd);border-radius:10px;box-shadow:var(--shl);z-index:90;max-height:320px;overflow-y:auto;display:none}
.sdd.open{display:block}
.si{padding:11px 14px;cursor:pointer;font-size:14px;border-bottom:1px solid var(--bdl);transition:background .12s}
.si:last-child{border:none}.si:hover,.si:active{background:var(--bgs)}
.si .nm{font-weight:600}.si .rg{color:var(--txmu);margin-left:6px}.si .el{color:var(--txl);margin-left:8px;font-size:12px}
.gwarn{font-size:11px;color:var(--dng);padding:5px 14px 0;display:none}

.frow{display:none;gap:6px;flex-wrap:wrap;margin-bottom:12px;align-items:center}.frow.show{display:flex}
.flbl{font-size:11px;color:var(--txmu);margin-right:2px}
.fc{display:inline-flex;align-items:center;gap:5px;padding:4px 11px;border-radius:18px;background:var(--card);color:var(--tx);border:1px solid var(--bd);font-size:12px;font-weight:500;cursor:pointer;white-space:nowrap;transition:all .2s}
.fc.act{background:var(--ac);color:#fff;border-color:var(--ac)}.fc .rx{margin-left:2px;opacity:.5;font-size:9px}

.lh{display:none;align-items:center;gap:10px;margin-bottom:14px;animation:fadeIn .3s ease}.lh.show{display:flex}
.lh h2{font-family:var(--sf);font-size:20px;font-weight:700;flex:1;line-height:1.3}
.lh .rg{font-size:12px;color:var(--txmu);display:block;font-weight:400}
.svb{font-size:12px;font-weight:600;color:var(--txmu);border:1px solid var(--bd);border-radius:7px;padding:6px 12px;transition:all .2s;background:transparent}
.svb.on{background:rgba(92,122,90,.08);color:var(--ac);border-color:rgba(92,122,90,.3)}

.drow{display:flex;gap:7px;overflow-x:auto;padding:4px 0 10px;-webkit-overflow-scrolling:touch;scrollbar-width:none}.drow::-webkit-scrollbar{display:none}
.dc{flex:0 0 auto;width:110px;background:var(--card);border:1.5px solid var(--bd);border-radius:13px;padding:12px 6px;text-align:center;cursor:pointer;transition:all .2s;position:relative}
.dc:hover{border-color:rgba(92,122,90,.45)}
.dc.sel{background:rgba(92,122,90,.04);border:2px solid var(--ac);box-shadow:0 3px 14px rgba(92,122,90,.12)}
.dc .dn{font-weight:700;font-size:13px}.dc .dd{font-size:11px;color:var(--txmu);margin-bottom:4px}
.dc .wi{font-size:26px;margin-bottom:3px}.dc .tm{font-family:var(--sf);font-size:14.5px;font-weight:600}
.dc .pp{font-size:10px;color:var(--txmu);margin-top:2px}
.dc .tr{font-size:9.5px;margin-top:2px;font-weight:600}
.bb{position:absolute;top:-8px;left:50%;transform:translateX(-50%);background:var(--ac);color:#fff;font-size:8.5px;font-weight:700;padding:2px 7px;border-radius:5px;text-transform:uppercase;letter-spacing:.6px;white-space:nowrap}

.scb{display:inline-flex;align-items:center;gap:6px;border-radius:8px;padding:4px 10px}
.scb.lg{gap:10px;border-radius:12px;padding:7px 15px}
.scb .sn2{font-weight:700;font-size:17px;line-height:1}.scb.lg .sn2{font-size:26px}
.scb .sl{font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:.9px}.scb.lg .sl{font-size:12px}

.dt{margin-top:14px;animation:fadeIn .3s ease}
.icd{background:var(--card);border:1px solid var(--bd);border-radius:11px;padding:18px;margin-bottom:12px}
.icd h4{font-family:var(--sf);font-size:16px;font-weight:700;margin-bottom:10px}
.pt{display:inline-block;background:rgba(74,124,89,.07);color:#4a7c59;font-size:11px;font-weight:600;border-radius:5px;padding:2px 9px;margin:0 4px 4px 0}
.iss{font-size:12.5px;color:#8b4513;padding:2px 0;line-height:1.45}
.tip{font-size:13px;line-height:1.6;margin:0 0 4px}
.divr{border-top:1px solid var(--bdl);padding-top:10px;margin-top:8px}
.wbn{background:rgba(92,122,90,.05);border:1px solid rgba(92,122,90,.17);border-radius:9px;padding:10px 14px;margin-bottom:12px;font-size:13.5px}
.wbn strong{font-weight:700;color:var(--ac)}

/* Trip Planner */
.tpln{background:var(--card);border:1px solid var(--bd);border-radius:11px;padding:18px;margin-bottom:12px}
.tpln h4{font-family:var(--sf);font-size:16px;font-weight:700;margin-bottom:10px}
.tp-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--bdl);font-size:13px}
.tp-row:last-child{border:none}
.tp-rank{font-weight:700;font-size:16px;width:28px;text-align:center;flex-shrink:0}
.tp-info{flex:1}.tp-day{font-weight:600}.tp-rec{font-size:12px;color:var(--txm);margin-top:1px}
.tp-form{margin-top:12px;padding-top:12px;border-top:1px solid var(--bdl)}
.tp-form label{font-size:11px;font-weight:600;color:var(--txmu);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px;margin-top:10px}
.tp-form label:first-child{margin-top:0}
.tp-form input,.tp-form textarea,.tp-form select{width:100%;padding:9px 12px;border:1.5px solid var(--bd);border-radius:8px;font-size:13.5px;color:var(--tx);background:var(--bg);outline:none}
.tp-form input:focus,.tp-form textarea:focus,.tp-form select:focus{border-color:var(--ac)}
.tp-form textarea{resize:vertical;min-height:60px}
.tp-day-sel{display:flex;flex-wrap:wrap;gap:5px;margin-top:4px}
.tp-ds{padding:6px 10px;border-radius:8px;border:1.5px solid var(--bd);font-size:12px;cursor:pointer;transition:all .15s;background:var(--bg);text-align:center;min-width:70px}
.tp-ds.on{background:var(--ac);color:#fff;border-color:var(--ac)}
.tp-ds .ds-day{font-weight:600}.tp-ds .ds-date{font-size:10px;opacity:.7}
.tp-energy-row{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12.5px}
.tp-energy-row .tp-ed{font-weight:600;min-width:80px}
.tp-energy-row select{width:auto;padding:5px 8px;font-size:12px;flex:1;max-width:160px}
.tp-go{margin-top:14px;font-size:13px;font-weight:600;background:var(--ac);color:#fff;border-radius:8px;padding:10px 20px;width:100%;transition:all .2s}
.tp-go:hover{background:var(--ach)}.tp-go:disabled{background:var(--bgs);color:var(--txmu)}

/* Trip Plan Output */
.tp-out{margin-top:14px;animation:fadeIn .3s ease}
.tp-day-card{background:var(--bg);border:1px solid var(--bdl);border-radius:10px;padding:14px;margin-bottom:10px}
.tp-day-card h5{font-family:var(--sf);font-size:15px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:8px}
.tp-day-card .tp-wx{font-size:12px;color:var(--txmu);margin-bottom:6px}
.tp-day-card .tp-advice{font-size:13px;line-height:1.6;margin-bottom:8px}
.tp-day-card .tp-advice p{margin:0 0 6px}

.aibtn{font-size:13px;font-weight:600;background:var(--ac);color:#fff;border-radius:8px;padding:8px 16px;transition:all .2s}
.aibtn:hover{background:var(--ach)}.aibtn:disabled{background:var(--bgs);color:var(--txmu);cursor:wait}
.aiout{font-size:13px;line-height:1.7;margin-top:12px}
.aiout p{margin:0 0 10px}

.chat-msgs{max-height:300px;overflow-y:auto;margin-top:12px;padding-top:8px;border-top:1px solid var(--bdl)}
.chat-msg{margin-bottom:10px;font-size:13px;line-height:1.6}
.chat-msg.user{color:var(--ac);font-weight:600}
.chat-msg.user::before{content:"You: "}
.chat-msg.ai p{margin:0 0 6px}
.chat-input-row{display:flex;gap:8px;margin-top:10px}
.chat-input{flex:1;border:1.5px solid var(--bd);border-radius:8px;padding:9px 12px;font-size:13.5px;color:var(--tx);background:var(--bg);outline:none;resize:none;min-height:40px;max-height:80px}
.chat-input:focus{border-color:var(--ac)}
.chat-send{background:var(--ac);color:#fff;border-radius:8px;padding:0 16px;font-size:13px;font-weight:600;transition:all .2s;flex-shrink:0}
.chat-send:hover{background:var(--ach)}.chat-send:disabled{background:var(--bgs);color:var(--txmu)}

.trl-item{padding:10px 0;border-bottom:1px solid var(--bdl)}.trl-item:last-child{border:none}
.trl-name{font-weight:600;font-size:14px}.trl-stats{font-size:12px;color:var(--txmu);margin:2px 0}
.trl-why{font-size:12.5px;color:var(--txm);line-height:1.5;margin:2px 0}
.trl-links{display:flex;gap:7px;margin-top:5px;flex-wrap:wrap}
.trl-links a{font-size:11px;font-weight:600;color:var(--ac);padding:3px 9px;border:1px solid rgba(92,122,90,.3);border-radius:6px;transition:all .15s}
.trl-links a:hover{background:rgba(92,122,90,.08);text-decoration:none}

.hw{background:var(--card);border:1px solid var(--bd);border-radius:11px;overflow:hidden;margin-bottom:14px}
.hw h4{font-family:var(--sf);font-size:16px;font-weight:700;padding:12px 14px 8px}
.hs{overflow-x:auto}.htbl{min-width:540px}
.hh{display:grid;grid-template-columns:56px 30px 62px 82px 66px 52px 52px;gap:5px;padding:3px 10px 6px;font-size:9.5px;color:var(--txmu);text-transform:uppercase;letter-spacing:.6px;font-weight:600;border-bottom:1.5px solid var(--bd)}
.hbd{max-height:400px;overflow-y:auto}
.hrow{display:grid;grid-template-columns:56px 30px 62px 82px 66px 52px 52px;gap:5px;align-items:center;padding:6px 10px;font-size:12px;border-bottom:1px solid var(--bdl)}
.hrow.ni{background:rgba(244,240,232,.5)}.hrow .ht2{font-weight:600}

.pttl{font-size:12px;color:var(--txmu);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:10px}
.pgr{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}
.pcd{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:10px 14px;cursor:pointer;font-size:13px;transition:all .2s}
.pcd:hover,.pcd:active{border-color:var(--ac);background:rgba(92,122,90,.03)}
.pcd .pn{font-weight:600}.pcd .pr{font-size:11px;color:var(--txmu);margin-top:1px}

.emp{text-align:center;padding:30px 20px 22px}
.emp .big{font-size:46px;margin-bottom:10px;opacity:.5}
.emp h2{font-family:var(--sf);font-size:22px;font-weight:600;margin-bottom:8px}
.emp p{font-size:13.5px;max-width:440px;margin:0 auto 24px;line-height:1.6;color:var(--txm)}
.ldg{text-align:center;padding:50px 20px;color:var(--txmu);display:none}
.ldg .li{font-size:36px;margin-bottom:10px;animation:pulse 1.5s ease-in-out infinite}
.erb{text-align:center;padding:24px 18px;margin-bottom:14px;background:rgba(196,90,60,.03);border:1px solid rgba(196,90,60,.15);border-radius:11px;display:none}
.erb .em{color:var(--dng);font-size:13px;margin-bottom:8px;line-height:1.5}
.erb button{font-size:13px;font-weight:600;background:var(--ac);color:#fff;border-radius:8px;padding:7px 14px}

.mbg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(59,50,38,.4);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.mbg.open{display:flex}
.mdl{background:var(--card);border-radius:16px;padding:26px 22px;max-width:420px;width:100%;box-shadow:var(--shl)}
.mdl h3{font-family:var(--sf);font-size:19px;font-weight:700;margin-bottom:5px}
.mdl p{font-size:12.5px;color:var(--txmu);line-height:1.5;margin-bottom:14px}
.mdl label{font-size:11px;font-weight:600;color:var(--txmu);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px}
.mdl input{width:100%;padding:9px 12px;border:1.5px solid var(--bd);border-radius:8px;font-size:14px;color:var(--tx);background:var(--bg);outline:none}
.mdl input:focus{border-color:var(--ac)}
.mdl .brow{display:flex;gap:8px;margin-top:16px;justify-content:flex-end}
.mdl .bcn{font-size:13px;font-weight:600;color:var(--txmu);padding:8px 14px;border-radius:8px;border:1px solid var(--bd)}
.mdl .bsv{font-size:13px;font-weight:600;background:var(--ac);color:#fff;padding:8px 18px;border-radius:8px}
.mdl .bsv:hover{background:var(--ach)}
.mdl .sts{font-size:11.5px;margin-top:6px}

.footer{text-align:center;padding:18px;font-size:11px;color:var(--txl);border-top:1px solid var(--bdl)}

/* Gear Checklist */
.gear-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.gear-item{font-size:12px;padding:4px 10px;border-radius:6px;display:inline-flex;align-items:center;gap:4px}
.gear-item.essential{background:rgba(196,90,60,.07);color:#8b4513;border:1px solid rgba(196,90,60,.15)}
.gear-item.recommended{background:rgba(92,122,90,.07);color:#4a7c59;border:1px solid rgba(92,122,90,.15)}
.gear-item.optional{background:rgba(154,142,125,.07);color:var(--txmu);border:1px solid var(--bdl)}

/* Elevation Toggle */
.elev-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px;padding:10px 14px;background:rgba(92,122,90,.04);border:1px solid rgba(92,122,90,.12);border-radius:9px;font-size:12.5px}
.elev-bar label{font-weight:600;color:var(--txm)}
.elev-bar input[type=number]{width:70px;padding:4px 8px;border:1.5px solid var(--bd);border-radius:6px;font-size:12px;text-align:center;background:var(--card);color:var(--tx)}
.elev-bar .elev-note{font-size:11px;color:var(--txmu);flex-basis:100%}
.elev-toggle{position:relative;width:40px;height:22px;border-radius:11px;background:var(--bd);cursor:pointer;transition:background .2s;flex-shrink:0}
.elev-toggle.on{background:var(--ac)}
.elev-toggle::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.15)}
.elev-toggle.on::after{transform:translateX(18px)}

/* Share Button */
.share-btn{display:inline-flex;align-items:center;gap:5px;font-size:13px;font-weight:600;color:#fff;background:var(--ac);border:none;border-radius:8px;padding:8px 16px;cursor:pointer;transition:all .2s;-webkit-appearance:none}
.share-btn:hover{background:var(--ach)}

@media(max-width:600px){.hdr h1{font-size:19px}.dc{width:102px}}
</style>
</head>
<body>

<div class="mbg" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="mdl">
    <h3>âš™ï¸ Settings</h3>
    <p>Enter your Anthropic API key for AI Trail Advisor. Stored only in this browser. <a href="https://console.anthropic.com/settings/keys" target="_blank">Get a key â†’</a></p>
    <label>API Key</label>
    <input type="password" id="keyIn" placeholder="sk-ant-..." autocomplete="off">
    <div id="kst" class="sts"></div>
    <div class="brow">
      <button class="bcn" onclick="closeModal()">Cancel</button>
      <button class="bsv" onclick="saveKey()">Save</button>
    </div>
  </div>
</div>

<header class="hdr"><div class="hdr-in"><div><div class="hdr-left"><span style="font-size:24px">â›°ï¸</span><h1>Trail Weather Advisor</h1></div><div class="sub">Weather-smart recommendations for serious day hikers</div></div><button class="gear" onclick="openModal()" title="Settings">âš™ï¸</button></div></header>

<main class="mn">
  <div class="swrap" id="swrap">
    <div class="srow">
      <div class="sbox" id="sbox"><span style="font-size:16px;opacity:.4">ğŸ”</span><input type="text" id="sinput" placeholder="Search a location..." autocomplete="off"><span id="sbusy" style="font-size:12px;color:var(--txmu);display:none">searching...</span></div>
      <button class="gps-btn" id="gpsbtn" onclick="useGPS()" title="Use my location">ğŸ“</button>
    </div>
    <div class="gwarn" id="gwarn"></div>
    <div class="sdd" id="sdd"></div>
  </div>
  <div class="frow" id="frow"></div>
  <div class="lh" id="lh"><div style="flex:1"><h2 id="locn"></h2><span class="rg" id="locr"></span></div><button class="svb" id="svb" onclick="toggleFav()">â˜† Save</button></div>
  <div class="ldg" id="ldg"><div class="li">â›°ï¸</div><div id="ldgt">Fetching forecast...</div></div>
  <div class="erb" id="erb"><div class="em" id="erm"></div><button onclick="doRetry()">Retry</button></div>
  <div id="empty"><div class="emp"><div class="big">ğŸ¥¾</div><h2>Where are you hiking?</h2><p>Search for a location, use ğŸ“ for your current location, or pick a popular area below.</p></div><div id="keyBnr" style="text-align:center;margin-bottom:18px"></div><div class="pttl">Popular Hiking Areas</div><div class="pgr" id="pgr"></div></div>
  <div id="wxc" style="display:none">
    <div class="drow" id="drow"></div>
    <div id="tpln"></div>
    <div id="ddet" class="dt"></div>
  </div>
</main>
<footer class="footer">Weather data from Open-Meteo Â· AI via Claude API Â· Built for serious hikers</footer>

<script>
var favs=[],curLoc=null,wxDays=null,selIdx=0,aiCache={},chatHistory={},tripChat=[],tripPlan=null,apiKey="";

var PRESETS=[
  {name:"Sedona",admin1:"Arizona",country:"US",latitude:34.8697,longitude:-111.7610,elevation:1320},
  {name:"Catskills (Hunter)",admin1:"New York",country:"US",latitude:42.1776,longitude:-74.2309,elevation:500},
  {name:"Catskills (Slide Mt)",admin1:"New York",country:"US",latitude:42.0069,longitude:-74.3862,elevation:800},
  {name:"Catskills (Blackhead)",admin1:"New York",country:"US",latitude:42.2440,longitude:-74.0654,elevation:600},
  {name:"Catskills (Kaaterskill)",admin1:"New York",country:"US",latitude:42.1975,longitude:-74.0586,elevation:360},
  {name:"White Mountains",admin1:"New Hampshire",country:"US",latitude:44.2706,longitude:-71.3033,elevation:600},
  {name:"Zion National Park",admin1:"Utah",country:"US",latitude:37.2982,longitude:-113.0263,elevation:1200},
  {name:"Grand Canyon",admin1:"Arizona",country:"US",latitude:36.0544,longitude:-112.1401,elevation:2100},
  {name:"Rocky Mountain NP",admin1:"Colorado",country:"US",latitude:40.3428,longitude:-105.6836,elevation:2400},
  {name:"Yosemite Valley",admin1:"California",country:"US",latitude:37.7459,longitude:-119.5332,elevation:1200},
  {name:"Great Smoky Mtns",admin1:"Tennessee",country:"US",latitude:35.6532,longitude:-83.5070,elevation:500},
  {name:"Acadia NP",admin1:"Maine",country:"US",latitude:44.3386,longitude:-68.2733,elevation:100},
  {name:"Mount Rainier",admin1:"Washington",country:"US",latitude:46.8523,longitude:-121.7603,elevation:1600},
  {name:"Joshua Tree",admin1:"California",country:"US",latitude:33.8734,longitude:-115.9010,elevation:790}
];

var WMO={0:"Clear sky",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",45:"Foggy",48:"Rime fog",51:"Light drizzle",53:"Moderate drizzle",55:"Dense drizzle",61:"Slight rain",63:"Moderate rain",65:"Heavy rain",66:"Light freezing rain",67:"Heavy freezing rain",71:"Slight snow",73:"Moderate snow",75:"Heavy snow",77:"Snow grains",80:"Slight showers",81:"Moderate showers",82:"Violent showers",85:"Light snow showers",86:"Heavy snow showers",95:"Thunderstorm",96:"T-storm w/ hail",99:"T-storm w/ heavy hail"};

function wI(c){if(c==null)return"â“";if(c<=1)return"â˜€ï¸";if(c<=3)return"â›…";if(c<=48)return"ğŸŒ«ï¸";if(c<=55)return"ğŸŒ¦ï¸";if(c<=65)return"ğŸŒ§ï¸";if(c<=67)return"ğŸ¥¶";if(c<=77)return"ğŸŒ¨ï¸";if(c<=82)return"ğŸŒ§ï¸";if(c<=86)return"ğŸŒ¨ï¸";return"â›ˆï¸";}
function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}

function computeScore(d){
  var s=100,iss=[],pos=[];var avg=(d.tmax+d.tmin)/2;
  if(avg>=45&&avg<=70)pos.push("Ideal temperature range");
  else if(d.tmax>90){s-=30;iss.push("Dangerously hot â€” heat exhaustion risk on steep climbs");}
  else if(d.tmax>85){s-=20;iss.push("Very warm â€” start early, carry extra water");}
  else if(d.tmax>78){s-=10;iss.push("Warm â€” pace yourself on uphill sections");}
  else if(d.tmin<20){s-=25;iss.push("Very cold â€” hypothermia risk, possible ice");}
  else if(d.tmin<32){s-=10;iss.push("Below freezing early â€” watch for ice on trails");}
  if(d.pprob<10)pos.push("Dry conditions expected");
  else if(d.pprob>70){s-=25;iss.push("High precipitation ("+d.pprob+"%) â€” wet, slippery trails");}
  else if(d.pprob>40){s-=12;iss.push("Moderate rain chance ("+d.pprob+"%) â€” bring rain gear");}
  else if(d.pprob>20){s-=5;iss.push("Slight rain chance ("+d.pprob+"%)");}
  if(d.psum>0.5){s-=10;iss.push("Significant accumulation â€” muddy conditions likely");}
  if(d.wmax<10)pos.push("Calm winds");
  else if(d.gmax>45){s-=30;iss.push("Dangerous gusts to "+Math.round(d.gmax)+" mph â€” avoid exposed ridges");}
  else if(d.gmax>30){s-=15;iss.push("Strong gusts to "+Math.round(d.gmax)+" mph â€” caution on ridgelines");}
  else if(d.wmax>20){s-=8;iss.push("Breezy ("+Math.round(d.wmax)+" mph) â€” may affect balance");}
  if(d.uvmax>8){s-=10;iss.push("Very high UV ("+d.uvmax.toFixed(1)+") â€” sunburn risk on exposed trails");}
  else if(d.uvmax>5){s-=3;iss.push("Moderate-high UV ("+d.uvmax.toFixed(1)+") â€” wear sunscreen");}
  else pos.push("Low UV exposure risk");
  var wc=d.wcode||0;
  if(wc>=95){s-=30;iss.push("Thunderstorms â€” do NOT hike exposed terrain");}
  else if(wc>=66&&wc<=67){s-=20;iss.push("Freezing rain â€” extremely dangerous");}
  else if(wc>=71&&wc<=77){s-=15;iss.push("Snow expected â€” traction may be needed");}
  s=Math.max(0,Math.min(100,s));var c,l;
  if(s>=85){c="#4a7c59";l="Excellent";}else if(s>=70){c="#6b8c42";l="Good";}
  else if(s>=50){c="#b8860b";l="Fair";}else if(s>=30){c="#c45a3c";l="Poor";}
  else{c="#8b2500";l="Avoid";}
  return{score:s,color:c,label:l,issues:iss,positives:pos};
}

function bestWin(hrs){
  if(!hrs||!hrs.length)return null;var bs=7,bsc=-1;
  for(var s=6;s<=14;s++){var ws=0;for(var h=s;h<Math.min(s+5,hrs.length);h++){var hr=hrs[h];if(!hr)continue;var sc=20;if(hr.pp>40)sc-=8;if(hr.ws>20)sc-=5;if(hr.t>=45&&hr.t<=72)sc+=5;if((hr.uv||0)<6)sc+=2;ws+=sc;}if(ws>bsc){bsc=ws;bs=s;}}
  bs=Math.max(6,bs);var end=Math.min(bs+5,20);function fmt(h){return(h%12||12)+":00 "+(h>=12?"PM":"AM");}return fmt(bs)+" â€“ "+fmt(end);
}

function calcTrend(hrs){
  var mS=0,aS=0,mC=0,aC=0;
  for(var h=6;h<18;h++){if(!hrs[h])continue;var sc=20;if(hrs[h].pp>40)sc-=8;if(hrs[h].ws>20)sc-=5;if(hrs[h].t>=45&&hrs[h].t<=72)sc+=5;if(h<12){mS+=sc;mC++;}else{aS+=sc;aC++;}}
  if(!mC||!aC)return"steady";var diff=(aS/aC)-(mS/mC);return diff>2?"improving":diff<-2?"worsening":"steady";
}

function getTips(d){
  var t=[],sc=d.hike.score;
  if(sc>=85)t.push("Outstanding conditions for an aggressive day hike.");
  else if(sc>=70)t.push("Solid hiking day. Good for challenging routes with preparation.");
  else if(sc>=50)t.push("Hikeable but plan carefully. Consider shorter or lower-elevation routes.");
  else t.push("Conditions are challenging. Choose sheltered, low-elevation trails.");
  if(d.wmax>25)t.push("Avoid exposed ridgelines and above-treeline sections.");
  if(d.pprob>50)t.push("Waterproof layers essential. Watch for flash flood zones.");
  if(d.tmax>85)t.push("Start early. Carry 3L+ water. Electrolytes for steep ascents.");
  if(d.tmin<32)t.push("Microspikes recommended. Watch for black ice on north-facing slopes.");
  if(d.uvmax>7)t.push("High UV â€” seek shaded trails or limit ridge exposure.");
  if(d.win)t.push("Best hiking window: "+d.win);return t;
}

function scbHTML(h,lg){var c=lg?"scb lg":"scb";return'<div class="'+c+'" style="background:'+h.color+'15"><span class="sn2" style="color:'+h.color+'">'+h.score+'</span><span class="sl" style="color:'+h.color+'">'+h.label+'</span></div>';}

function allWxSummary(){
  if(!wxDays)return"";
  return wxDays.map(function(d){
    var dt=new Date(d.date+"T12:00:00");
    return dt.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"})+": "+Math.round(d.tmax)+"Â°/"+Math.round(d.tmin)+"Â°F, "+(WMO[d.wcode]||"")+", precip "+d.pprob+"%, wind "+Math.round(d.wmax)+" mph gusts "+Math.round(d.gmax)+", UV "+d.uvmax.toFixed(1)+", score "+d.hike.score+"/100 ("+d.hike.label+"), trend: "+d.trend+", best window: "+d.win;
  }).join("\n");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function geocodeAPI(q){
  return fetch("https://geocoding-api.open-meteo.com/v1/search?name="+encodeURIComponent(q)+"&count=8&language=en&format=json")
    .then(function(r){if(!r.ok)throw new Error("HTTP "+r.status);return r.json();})
    .then(function(d){return{ok:true,results:d.results||[]};})
    .catch(function(e){return{ok:false,error:e.message,results:[]};});
}
function reverseGeocode(lat,lon){
  return fetch("https://geocoding-api.open-meteo.com/v1/search?name="+lat.toFixed(2)+","+lon.toFixed(2)+"&count=1&language=en&format=json")
    .then(function(r){return r.json();}).then(function(d){return d.results&&d.results.length?d.results[0]:{name:"My Location",latitude:lat,longitude:lon,admin1:"",country:""};})
    .catch(function(){return{name:"My Location",latitude:lat,longitude:lon,admin1:"",country:""};});
}
function weatherAPI(lat,lon){
  var hp=["temperature_2m","relative_humidity_2m","apparent_temperature","precipitation_probability","precipitation","weather_code","cloud_cover","visibility","wind_speed_10m","wind_gusts_10m","uv_index"].join(",");
  var dp=["temperature_2m_max","temperature_2m_min","apparent_temperature_max","apparent_temperature_min","precipitation_sum","precipitation_probability_max","wind_speed_10m_max","wind_gusts_10m_max","uv_index_max","weather_code","sunrise","sunset"].join(",");
  return fetch("https://api.open-meteo.com/v1/forecast?latitude="+lat+"&longitude="+lon+"&hourly="+hp+"&daily="+dp+"&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=auto&forecast_days=7")
    .then(function(r){if(!r.ok)throw new Error("HTTP "+r.status);return r.json();})
    .then(function(d){return{ok:true,data:d};}).catch(function(e){return{ok:false,error:e.message};});
}
function parseWx(data){
  return data.daily.time.map(function(date,i){
    var hrs=[];for(var h=0;h<24;h++){var idx=i*24+h;if(idx<(data.hourly&&data.hourly.time?data.hourly.time.length:0)){hrs.push({time:data.hourly.time[idx],t:data.hourly.temperature_2m[idx],at:data.hourly.apparent_temperature[idx],rh:data.hourly.relative_humidity_2m[idx],pp:data.hourly.precipitation_probability[idx],pr:data.hourly.precipitation[idx],wc:data.hourly.weather_code[idx],cc:data.hourly.cloud_cover[idx],vis:data.hourly.visibility[idx],ws:data.hourly.wind_speed_10m[idx],wg:data.hourly.wind_gusts_10m[idx],uv:data.hourly.uv_index[idx]});}}
    var sr=data.daily.sunrise[i]?new Date(data.daily.sunrise[i]).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}):"";
    var ss=data.daily.sunset[i]?new Date(data.daily.sunset[i]).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}):"";
    var d={date:date,hrs:hrs,disp:new Date(date+"T12:00:00").toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}),tmax:data.daily.temperature_2m_max[i],tmin:data.daily.temperature_2m_min[i],atmax:data.daily.apparent_temperature_max[i],psum:data.daily.precipitation_sum[i],pprob:data.daily.precipitation_probability_max[i],wmax:data.daily.wind_speed_10m_max[i],gmax:data.daily.wind_gusts_10m_max[i],uvmax:data.daily.uv_index_max[i],wcode:data.daily.weather_code[i],sr:sr,ss:ss};
    d.hike=computeScore(d);d.win=bestWin(hrs);d.trend=calcTrend(hrs);return d;
  });
}

function claudeAPI(system,messages,maxTok){
  return fetch("https://api.anthropic.com/v1/messages",{
    method:"POST",headers:{"Content-Type":"application/json","x-api-key":apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
    body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:maxTok||1500,system:system,messages:messages})
  }).then(function(r){
    if(r.status===401)throw new Error("Invalid API key. Check Settings.");
    if(!r.ok)throw new Error("API error: HTTP "+r.status);return r.json();
  }).then(function(data){return(data.content||[]).map(function(b){return b.text||"";}).join("\n");});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Per-Day AI Advisor
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildDaySystem(day,locName){
  return'You are an expert hiking advisor. The hiker is experienced â€” wants aggressive inclines, significant elevation gain, 4-8 hour day hikes. They love gorgeous views (top priority), prefer solitude and quiet trails. If a trail is crowded but exceptional, mention the trade-off. Earliest start: 6 AM, typical: 7-8 AM. Based in NYC area, frequently hikes the Catskills.\n\nCurrent location: '+locName+'\nWeather for '+day.disp+': High '+day.tmax+'Â°F, Low '+day.tmin+'Â°F, Feels like '+day.atmax+'Â°F. Precip: '+day.pprob+'% chance, '+day.psum+'". Wind: '+day.wmax+' mph, gusts '+day.gmax+'. UV: '+day.uvmax+'. '+(WMO[day.wcode]||"")+'. Sunrise '+day.sr+', Sunset '+day.ss+'. Score: '+day.hike.score+'/100 ('+day.hike.label+'). Best window: '+day.win+'.';
}

function callAI(day,locName){
  if(!apiKey)return Promise.resolve(null);
  var sys=buildDaySystem(day,locName);
  var userMsg='Provide a concise tactical assessment in short paragraphs (no bullet points, no headers). Cover conditions, gear beyond basics, optimal timing, safety. Be specific to '+locName+'\'s geography. Mention which trails offer the best views.\n\nIMPORTANT â€” After your assessment, you MUST output 3-5 trail suggestions as a JSON array wrapped in <trails> tags:\n\n<trails>\n[{"name":"Trail Name Here","distance":"5.2 miles","elevation":"1800 ft gain","difficulty":"Strenuous","why":"Stunning views with very few hikers","alltrails":"Trail Name Here '+locName+'","webUrl":"https://example.com or empty string","crowdLevel":"Low"}]\n</trails>\n\nRules: alltrails field MUST include trail name AND "'+locName+'". crowdLevel must be "Low", "Moderate", or "High". Prioritize views and low crowds. Do NOT skip the <trails> section.';
  var msgs=[{role:"user",content:userMsg}];
  return claudeAPI(sys,msgs).then(function(text){
    var trails=[];var tm=text.match(/<trails>([\s\S]*?)<\/trails>/);
    if(tm){try{trails=JSON.parse(tm[1].trim());}catch(e){}}
    var assessment=text.replace(/<trails>[\s\S]*?<\/trails>/,"").trim();
    chatHistory[selIdx]=[{role:"user",content:userMsg},{role:"assistant",content:text}];
    return{assessment:assessment,trails:trails};
  });
}

function sendDayChat(msg){
  if(!apiKey||!wxDays)return;
  var day=wxDays[selIdx];var sys=buildDaySystem(day,curLoc.name);
  if(!chatHistory[selIdx])chatHistory[selIdx]=[];
  chatHistory[selIdx].push({role:"user",content:msg});
  return claudeAPI(sys,chatHistory[selIdx].slice(-10)).then(function(text){
    chatHistory[selIdx].push({role:"assistant",content:text});return text;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Trip Mode AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildTripSystem(){
  return'You are an expert hiking trip planner. The hiker is experienced â€” loves gorgeous views (top priority), prefers solitude, wants aggressive inclines on strenuous days. Earliest start: 6 AM, typical: 7-8 AM. Based in NYC, frequently hikes the Catskills.\n\nLocation: '+curLoc.name+' ('+curLoc.region+')\n\n7-DAY FORECAST:\n'+allWxSummary()+'\n\nWhen suggesting trails, consider drive time from the hiker\'s lodging location. Try to cluster nearby trails on the same day. Avoid suggesting trails on opposite ends of the region on consecutive days unless weather forces it.';
}

function callTripAI(selectedDays,energyMap,lodging,notes){
  if(!apiKey)return Promise.resolve(null);
  var sys=buildTripSystem();
  var dayDescs=selectedDays.map(function(i){
    var d=wxDays[i];var dt=new Date(d.date+"T12:00:00");
    return dt.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"})+" (score "+d.hike.score+"/100, "+d.hike.label+") â€” Energy: "+energyMap[i];
  }).join("\n");
  var userMsg='Plan my '+selectedDays.length+'-day hiking trip near '+curLoc.name+'.\n\nDAYS I\'M HIKING:\n'+dayDescs+'\n'+(lodging?'LODGING: I\'m staying near '+lodging+'. Factor in drive time to trailheads.\n':'')+(notes?'ADDITIONAL NOTES: '+notes+'\n':'')+'\nFor EACH day, provide:\n1. A paragraph of tactical advice â€” focus on strategy, timing, gear, and trail selection rationale. Do NOT restate temperatures or weather stats (they are already displayed to the user). Instead focus on what the weather MEANS for hiking.\n2. 1-2 trail recommendations matched to that day\'s conditions and energy budget\n\nOutput the full plan as JSON wrapped in <tripplan> tags:\n\n<tripplan>\n[{"dayIndex":0,"dayLabel":"Monday, Feb 9","advice":"Tactical advice paragraph â€” no weather numbers, focus on strategy...","trails":[{"name":"Trail Name","distance":"5 miles","elevation":"1800 ft gain","difficulty":"Strenuous","why":"Why this trail on this day","alltrails":"Trail Name '+curLoc.name+'","webUrl":"","crowdLevel":"Low","driveTime":"20 min from Uptown Sedona"}]}]\n</tripplan>\n\nRules:\n- dayIndex must match the forecast day index (0-6)\n- alltrails field MUST include trail name AND "'+curLoc.name+'"  \n- crowdLevel: "Low", "Moderate", or "High"\n- Include driveTime from lodging if provided\n- Match trail difficulty to each day\'s energy level (Strenuous/Moderate/Easy)\n- Put the hardest hike on the best weather day\n- Prioritize views and solitude\n- Do NOT restate temperature, wind, or precip numbers in the advice â€” the user already sees these\n- Do NOT skip the <tripplan> section';
  tripChat=[{role:"user",content:userMsg}];
  return claudeAPI(sys,[{role:"user",content:userMsg}],2500).then(function(text){
    tripChat.push({role:"assistant",content:text});
    var plan=[];var tm=text.match(/<tripplan>([\s\S]*?)<\/tripplan>/);
    if(tm){try{plan=JSON.parse(tm[1].trim());}catch(e){}}
    var overview=text.replace(/<tripplan>[\s\S]*?<\/tripplan>/,"").trim();
    return{overview:overview,days:plan};
  });
}

function sendTripChat(msg){
  if(!apiKey)return;var sys=buildTripSystem();
  tripChat.push({role:"user",content:msg+'\n\nIMPORTANT: You MUST respond with an updated trip plan in <tripplan> JSON tags using the same format as before, with dayIndex, dayLabel, advice, and trails array (including name, distance, elevation, difficulty, why, alltrails with location, webUrl, crowdLevel, driveTime). Always include the full updated plan, not just the changes.'});
  return claudeAPI(sys,tripChat.slice(-10),2500).then(function(text){
    tripChat.push({role:"assistant",content:text});return text;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function useGPS(){
  if(!navigator.geolocation){alert("Geolocation not available.");return;}
  var btn=document.getElementById("gpsbtn");btn.classList.add("loading");btn.textContent="â³";
  navigator.geolocation.getCurrentPosition(function(pos){
    btn.classList.remove("loading");btn.textContent="ğŸ“";
    reverseGeocode(pos.coords.latitude,pos.coords.longitude).then(function(geo){
      selectLoc({name:geo.name||"My Location",latitude:pos.coords.latitude,longitude:pos.coords.longitude,admin1:geo.admin1||"",country:geo.country||""});
    });
  },function(err){
    btn.classList.remove("loading");btn.textContent="ğŸ“";
    alert(err.code===1?"Location access denied.":"Could not get location: "+err.message);
  },{enableHighAccuracy:true,timeout:10000});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Settings / Favorites / Search
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(){document.getElementById("modal").classList.add("open");document.getElementById("keyIn").value=apiKey;document.getElementById("kst").textContent="";document.getElementById("keyIn").focus();}
function closeModal(){document.getElementById("modal").classList.remove("open");}
function saveKey(){
  var k=document.getElementById("keyIn").value.trim();
  if(k&&!k.startsWith("sk-ant")){document.getElementById("kst").innerHTML='<span style="color:var(--dng)">Key should start with sk-ant...</span>';return;}
  apiKey=k;try{localStorage.setItem("twx-key",k);}catch(e){}
  document.getElementById("kst").innerHTML='<span style="color:var(--ac)">âœ“ Saved</span>';updateKeyBanner();setTimeout(closeModal,800);
}
function updateKeyBanner(){
  var el=document.getElementById("keyBnr");
  if(!apiKey)el.innerHTML='<div style="display:inline-block;background:rgba(92,122,90,.06);border:1px solid rgba(92,122,90,.2);border-radius:10px;padding:10px 18px;font-size:13px;color:var(--txm)">ğŸ’¡ Tap âš™ï¸ to add your <a href="https://console.anthropic.com/settings/keys" target="_blank">Anthropic API key</a> for AI features</div>';
  else el.innerHTML='<div style="display:inline-block;background:rgba(92,122,90,.06);border:1px solid rgba(92,122,90,.2);border-radius:10px;padding:10px 18px;font-size:13px;color:var(--ac)">âœ“ AI Trail Advisor enabled</div>';
}

function loadFavs(){try{var s=localStorage.getItem("twx-favs");if(s)favs=JSON.parse(s);}catch(e){}drawFavs();}
function saveFavs(){try{localStorage.setItem("twx-favs",JSON.stringify(favs));}catch(e){}drawFavs();}
function drawFavs(){
  var el=document.getElementById("frow");if(!favs.length){el.className="frow";return;}el.className="frow show";
  el.innerHTML='<span class="flbl">Favorites:</span>'+favs.map(function(f,i){var act=curLoc&&curLoc.name===f.name&&curLoc.lat===f.lat?" act":"";return'<div class="fc'+act+'" onclick="pickFav('+i+')"><span>ğŸ“ '+esc(f.name)+'</span><span class="rx" onclick="event.stopPropagation();rmFav('+i+')">âœ•</span></div>';}).join("");
}
function toggleFav(){if(!curLoc)return;var idx=favs.findIndex(function(f){return f.name===curLoc.name&&f.lat===curLoc.lat;});if(idx>=0)favs.splice(idx,1);else favs.push({name:curLoc.name,lat:curLoc.lat,lon:curLoc.lon,region:curLoc.region,admin1:curLoc.admin1,country:curLoc.country});saveFavs();updSvb();}
function rmFav(i){favs.splice(i,1);saveFavs();}
function pickFav(i){var f=favs[i];selectLoc({name:f.name,latitude:f.lat,longitude:f.lon,admin1:f.admin1||"",country:f.country||""});}
function updSvb(){var b=document.getElementById("svb");if(!curLoc)return;var is=favs.some(function(f){return f.name===curLoc.name&&f.lat===curLoc.lat;});b.className=is?"svb on":"svb";b.textContent=is?"â˜… Saved":"â˜† Save";}

var stimer=null,searchRes=[];
var sinput=document.getElementById("sinput"),sdd=document.getElementById("sdd");
sinput.addEventListener("input",function(){
  clearTimeout(stimer);var q=sinput.value.trim();
  if(q.length<2){sdd.className="sdd";sdd.innerHTML="";return;}
  document.getElementById("sbusy").style.display="inline";
  stimer=setTimeout(function(){
    geocodeAPI(q).then(function(geo){
      if(geo.ok&&geo.results.length>0)searchRes=geo.results.slice(0,6);
      else{var lw=q.toLowerCase();searchRes=PRESETS.filter(function(p){return p.name.toLowerCase().indexOf(lw)>=0||(p.admin1||"").toLowerCase().indexOf(lw)>=0;});}
      document.getElementById("sbusy").style.display="none";
      if(searchRes.length>0){
        sdd.innerHTML=searchRes.map(function(r,i){var rg=[r.admin1,r.country].filter(Boolean).join(", ");var el=r.elevation!=null?'<span class="el">'+Math.round(r.elevation*3.281).toLocaleString()+' ft</span>':"";return'<div class="si" data-i="'+i+'"><span class="nm">'+esc(r.name)+'</span><span class="rg">'+esc(rg)+'</span>'+el+'</div>';}).join("");
        sdd.className="sdd open";
        sdd.querySelectorAll(".si").forEach(function(el){el.addEventListener("click",function(){selectLoc(searchRes[parseInt(this.getAttribute("data-i"))]);sinput.value="";sdd.className="sdd";});});
      }else sdd.className="sdd";
    });
  },350);
});
sinput.addEventListener("focus",function(){document.getElementById("sbox").classList.add("fo");if(sdd.children.length>0)sdd.className="sdd open";});
document.addEventListener("click",function(e){if(!document.getElementById("swrap").contains(e.target)){sdd.className="sdd";document.getElementById("sbox").classList.remove("fo");}});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Location & Weather
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectLoc(geo){
  curLoc={name:geo.name,lat:geo.latitude,lon:geo.longitude,region:[geo.admin1,geo.country].filter(Boolean).join(", "),admin1:geo.admin1||"",country:geo.country||""};
  selIdx=0;aiCache={};chatHistory={};tripChat=[];tripPlan=null;
  document.getElementById("empty").style.display="none";
  document.getElementById("wxc").style.display="none";
  document.getElementById("erb").style.display="none";
  document.getElementById("lh").className="lh";
  document.getElementById("ldg").style.display="block";
  document.getElementById("ldgt").textContent="Fetching forecast for "+curLoc.name+"...";
  drawFavs();
  weatherAPI(curLoc.lat,curLoc.lon).then(function(res){
    document.getElementById("ldg").style.display="none";
    if(res.ok&&res.data&&res.data.daily){try{wxDays=parseWx(res.data);renderWx();}catch(e){showErr("Parse error: "+e.message);}}
    else showErr("Failed to fetch weather"+(res.error?": "+res.error:""));
  });
}
function doRetry(){if(curLoc)selectLoc({name:curLoc.name,latitude:curLoc.lat,longitude:curLoc.lon,admin1:curLoc.admin1,country:curLoc.country});}
function showErr(m){document.getElementById("erb").style.display="block";document.getElementById("erm").textContent=m;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Render Weather
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWx(){
  if(!wxDays)return;
  document.getElementById("locn").textContent=curLoc.name;
  document.getElementById("locr").textContent=curLoc.region||"";
  document.getElementById("lh").className="lh show";updSvb();
  var bestI=0;wxDays.forEach(function(d,i){if(d.hike.score>wxDays[bestI].hike.score)bestI=i;});
  document.getElementById("drow").innerHTML=wxDays.map(function(day,i){
    var dt=new Date(day.date+"T12:00:00");var dn=dt.toLocaleDateString("en-US",{weekday:"short"});var md=dt.toLocaleDateString("en-US",{month:"short",day:"numeric"});
    var tH="";if(day.trend==="improving")tH='<div class="tr" style="color:#4a7c59">â†— Improving</div>';else if(day.trend==="worsening")tH='<div class="tr" style="color:#c45a3c">â†˜ Worsening</div>';
    var ppH="";if(day.pprob>20){ppH='<div class="pp">ğŸ’§ '+day.pprob+'%'+(day.psum>=0.1?' Â· '+day.psum+'"':'')+'</div>';}
    return'<div class="dc'+(i===selIdx?" sel":"")+'" onclick="pickDay('+i+')" id="dc'+i+'">'+(i===bestI?'<div class="bb">Best Day</div>':'')+'<div class="dn">'+dn+'</div><div class="dd">'+md+'</div><div class="wi">'+wI(day.wcode)+'</div><div class="tm">'+Math.round(day.tmax)+'Â° / '+Math.round(day.tmin)+'Â°</div><div style="margin-top:5px">'+scbHTML(day.hike,false)+'</div>'+tH+ppH+'</div>';
  }).join("");
  document.getElementById("wxc").style.display="block";
  document.getElementById("empty").style.display="none";
  document.getElementById("erb").style.display="none";
  renderTripPlanner();renderDetail();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Trip Planner
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var tpSelDays={};
function renderTripPlanner(){
  if(!wxDays||wxDays.length<2){document.getElementById("tpln").innerHTML="";return;}
  // Rankings
  var ranked=wxDays.map(function(d,i){return{idx:i,score:d.hike.score,label:d.hike.label,color:d.hike.color,date:d.date};}).sort(function(a,b){return b.score-a.score;});
  var recs=["Best for your hardest hike","Second-best for a challenging route","Good backup for moderate effort"];
  var html='<div class="tpln"><h4>ğŸ“‹ Trip Planner</h4>';
  // Quick rankings
  html+='<div style="margin-bottom:14px">';
  ranked.forEach(function(r,i){
    if(i>=3)return;var dt=new Date(r.date+"T12:00:00");var dayN=dt.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"});
    var medal=i===0?"ğŸ¥‡":i===1?"ğŸ¥ˆ":"ğŸ¥‰";
    html+='<div class="tp-row" style="cursor:pointer" onclick="pickDay('+r.idx+')"><div class="tp-rank">'+medal+'</div><div class="tp-info"><div class="tp-day">'+dayN+' <span style="font-weight:400;color:var(--txmu)">â€” '+r.score+'/100</span></div><div class="tp-rec">'+(recs[i]||"")+'</div></div>'+scbHTML({score:r.score,color:r.color,label:r.label},false)+'</div>';
  });
  html+='</div>';

  // Trip Mode form
  if(apiKey){
    html+='<div class="tp-form" id="tpform"><div style="font-size:14px;font-weight:600;margin-bottom:8px">ğŸ—ºï¸ Plan My Trip</div><div style="font-size:12px;color:var(--txmu);margin-bottom:10px">Select which days you\'re hiking and set your energy level for each. The AI will build an optimized itinerary with trail assignments and drive logistics.</div>';
    html+='<label>Which days are you hiking? (tap to select)</label><div class="tp-day-sel" id="tpdays">';
    wxDays.forEach(function(d,i){
      var dt=new Date(d.date+"T12:00:00");var dn=dt.toLocaleDateString("en-US",{weekday:"short"});var md=dt.toLocaleDateString("en-US",{month:"short",day:"numeric"});
      var on=tpSelDays[i]?" on":"";
      html+='<div class="tp-ds'+on+'" onclick="toggleTpDay('+i+')" id="tpd'+i+'"><div class="ds-day">'+dn+'</div><div class="ds-date">'+md+'</div></div>';
    });
    html+='</div>';
    html+='<div id="tpEnergy" style="margin-top:10px"></div>';
    html+='<label>Where are you staying?</label><input type="text" id="tpLodge" placeholder="e.g. Uptown Sedona, near Village of Oak Creek...">';
    html+='<label>Anything else? (optional)</label><textarea id="tpNotes" placeholder="e.g. Want one sunset hike, prefer scrambles, need a rest day..."></textarea>';
    html+='<button class="tp-go" id="tpgo" onclick="runTripAI()">Build My Trip Plan</button>';
    html+='</div>';
  }else{
    html+='<div style="font-size:12px;color:var(--txmu);margin-top:6px;padding-top:10px;border-top:1px solid var(--bdl)">Add your API key in âš™ï¸ Settings to enable AI trip planning.</div>';
  }

  // Trip plan output
  if(tripPlan){
    html+=renderTripPlan();
  }
  html+='</div>';
  document.getElementById("tpln").innerHTML=html;
  renderEnergySelectors();
}

function toggleTpDay(i){
  tpSelDays[i]=!tpSelDays[i];
  var el=document.getElementById("tpd"+i);
  if(el)el.classList.toggle("on",!!tpSelDays[i]);
  renderEnergySelectors();
}

function renderEnergySelectors(){
  var el=document.getElementById("tpEnergy");if(!el)return;
  var days=Object.keys(tpSelDays).filter(function(k){return tpSelDays[k];}).map(Number).sort();
  if(!days.length){el.innerHTML="";return;}
  el.innerHTML='<label>Energy level per day</label>'+days.map(function(i){
    var d=wxDays[i];var dt=new Date(d.date+"T12:00:00");var dn=dt.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});
    var val=document.querySelector("#tpe"+i)?document.querySelector("#tpe"+i).value:"strenuous";
    return'<div class="tp-energy-row"><span class="tp-ed">'+dn+'</span><select id="tpe'+i+'"><option value="strenuous"'+(val==="strenuous"?" selected":"")+'>Strenuous</option><option value="moderate"'+(val==="moderate"?" selected":"")+'>Moderate</option><option value="easy"'+(val==="easy"?" selected":"")+'>Easy / Recovery</option><option value="rest"'+(val==="rest"?" selected":"")+'>Rest (no hike)</option></select></div>';
  }).join("");
}

function runTripAI(){
  var days=Object.keys(tpSelDays).filter(function(k){return tpSelDays[k];}).map(Number).sort();
  if(days.length<1){alert("Select at least one day.");return;}
  var energyMap={};days.forEach(function(i){var sel=document.getElementById("tpe"+i);energyMap[i]=sel?sel.value:"strenuous";});
  var lodging=(document.getElementById("tpLodge")||{}).value||"";
  var notes=(document.getElementById("tpNotes")||{}).value||"";
  var btn=document.getElementById("tpgo");
  btn.disabled=true;btn.textContent="Building your trip plan...";
  callTripAI(days,energyMap,lodging,notes).then(function(result){
    btn.disabled=false;btn.textContent="Rebuild Trip Plan";
    if(result){tripPlan=result;renderTripPlanner();}
  }).catch(function(e){
    btn.disabled=false;btn.textContent="Retry Trip Plan";
    alert("Error: "+e.message);
  });
}

function renderTripPlan(){
  if(!tripPlan)return"";
  var html='<div class="tp-out"><div style="font-weight:700;font-size:14px;margin-bottom:8px">Your Trip Plan</div><div style="margin-bottom:12px"><div class="share-btn" id="sharebtn" onclick="shareTripPlan()" role="button">ğŸ“¤ Share Plan</div></div>';
  if(tripPlan.overview)html+='<div style="font-size:13px;line-height:1.6;margin-bottom:14px">'+formatAI(tripPlan.overview)+'</div>';
  if(tripPlan.days&&tripPlan.days.length){
    tripPlan.days.forEach(function(day){
      var wxDay=wxDays[day.dayIndex];
      var dayDate=wxDay?new Date(wxDay.date+"T12:00:00").toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"}):day.dayLabel;
      html+='<div class="tp-day-card"><h5><span>'+wI(wxDay?wxDay.wcode:null)+'</span> '+esc(dayDate)+'</h5>';
      if(wxDay)html+='<div class="tp-wx">'+Math.round(wxDay.tmax)+'Â°/'+Math.round(wxDay.tmin)+'Â°F Â· '+(WMO[wxDay.wcode]||"")+(wxDay.pprob>20?" Â· ğŸ’§ "+wxDay.pprob+"%"+(wxDay.psum>=0.1?" Â· "+wxDay.psum+'"':""):"")+" Â· Wind "+Math.round(wxDay.wmax)+" mph Â· "+scbHTML(wxDay.hike,false)+' Â· '+wxDay.win+'</div>';
      if(day.advice)html+='<div class="tp-advice">'+formatAI(day.advice)+'</div>';
      if(day.trails&&day.trails.length)html+=renderTrailsInline(day.trails);
      html+='</div>';
    });
  }
  // Trip chat - show follow-up messages but strip tripplan JSON
  var followUps=tripChat.slice(2);
  if(followUps.length){
    html+='<div class="chat-msgs" id="tripchatmsgs">';
    followUps.forEach(function(m){
      if(m.role==="user"){
        // Strip the instruction suffix we append
        var ci=m.content.indexOf("\n\nIMPORTANT:");
        var cleanMsg=ci>=0?m.content.substring(0,ci):m.content;
        html+='<div class="chat-msg user">'+esc(cleanMsg)+'</div>';
      }else{
        // Strip tripplan JSON from display
        var s1=m.content.indexOf("<"+"tripplan>");
        var s2=m.content.indexOf("</"+"tripplan>");
        var cleanResp=m.content;
        if(s1>=0&&s2>=0)cleanResp=(m.content.substring(0,s1)+m.content.substring(s2+12)).trim();
        if(cleanResp)html+='<div class="chat-msg ai">'+formatAI(cleanResp)+'</div>';
        else html+='<div class="chat-msg ai"><p style="color:var(--ac)">âœ“ Plan updated above.</p></div>';
      }
    });
    html+='</div>';
  }
  html+='<div class="chat-input-row"><textarea class="chat-input" id="tripchatinput" placeholder="Adjust the plan... e.g. swap days, suggest something shorter, add a sunset hike..." rows="1" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();handleTripChat();}"></textarea><button class="chat-send" id="tripchatsend" onclick="handleTripChat()">Send</button></div>';
  html+='</div>';
  return html;
}

function handleTripChat(){
  var input=document.getElementById("tripchatinput");
  var btn=document.getElementById("tripchatsend");
  var msg=input.value.trim();if(!msg||!apiKey)return;
  input.value="";input.disabled=true;btn.disabled=true;btn.textContent="...";
  var container=document.getElementById("tripchatmsgs");
  if(!container){var inputRow=input.closest(".chat-input-row");container=document.createElement("div");container.className="chat-msgs";container.id="tripchatmsgs";inputRow.parentNode.insertBefore(container,inputRow);}
  container.innerHTML+='<div class="chat-msg user">'+esc(msg)+'</div><div class="chat-msg ai" id="tripchatloading" style="color:var(--txmu)">Updating plan...</div>';
  container.scrollTop=container.scrollHeight;
  sendTripChat(msg).then(function(text){
    // Check if response contains a new trip plan
    var s1=text.indexOf("<"+"tripplan>");
    var s2=text.indexOf("</"+"tripplan>");
    if(s1>=0&&s2>=0){
      try{
        var jsonStr=text.substring(s1+10,s2).trim();
        var newDays=JSON.parse(jsonStr);
        var overview=(text.substring(0,s1)+text.substring(s2+12)).trim();
        tripPlan={overview:overview||tripPlan.overview,days:newDays};
        renderTripPlanner();
        return;
      }catch(e){
        // JSON parse failed
      }
    }
    // Fallback: strip any tripplan tags and show remaining text
    var clean=text;
    if(s1>=0&&s2>=0)clean=(text.substring(0,s1)+text.substring(s2+12)).trim();
    var ldg=document.getElementById("tripchatloading");
    if(ldg)ldg.outerHTML='<div class="chat-msg ai">'+(clean?formatAI(clean):'<p>Could not parse the updated plan. Try rephrasing.</p>')+'</div>';
    input=document.getElementById("tripchatinput");btn=document.getElementById("tripchatsend");
    if(input){input.disabled=false;}if(btn){btn.disabled=false;btn.textContent="Send";}
    if(input)input.focus();
    var c=document.getElementById("tripchatmsgs");if(c)c.scrollTop=c.scrollHeight;
  }).catch(function(e){
    var ldg=document.getElementById("tripchatloading");
    if(ldg)ldg.outerHTML='<div class="chat-msg ai" style="color:var(--dng)">Error: '+esc(e.message)+'</div>';
    input.disabled=false;btn.disabled=false;btn.textContent="Send";
  });
}

function pickDay(i){selIdx=i;document.querySelectorAll(".dc").forEach(function(el,j){el.classList.toggle("sel",j===i);});renderDetail();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Gear Checklist
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildGearList(day){
  var g={essential:[],recommended:[],optional:[]};
  // Always
  g.essential.push("Water (2-3L)","Trail shoes","Navigation (phone/map)");
  // Temperature
  if(day.tmin<32){g.essential.push("Microspikes","Insulated layers","Warm gloves","Beanie");g.recommended.push("Hand warmers","Thermos w/ hot drink");}
  else if(day.tmin<45){g.essential.push("Fleece midlayer","Light gloves");g.recommended.push("Warm hat");}
  else if(day.tmax>85){g.essential.push("Extra water (+1L)","Electrolytes","Sun hat");g.recommended.push("Cooling towel","Salty snacks");}
  else if(day.tmax>75){g.recommended.push("Sun hat","Electrolytes");}
  // Precipitation
  if(day.pprob>50){g.essential.push("Rain jacket","Pack cover");g.recommended.push("Rain pants","Dry bags for electronics");}
  else if(day.pprob>25){g.recommended.push("Packable rain shell");}
  // Wind
  if(day.gmax>30){g.essential.push("Wind shell","Secure hat/buff");g.recommended.push("Balaclava");}
  else if(day.wmax>15){g.recommended.push("Wind layer");}
  // UV
  if(day.uvmax>7){g.essential.push("SPF 50+ sunscreen","UV sunglasses");g.recommended.push("UPF shirt","Lip balm w/ SPF");}
  else if(day.uvmax>4){g.recommended.push("Sunscreen","Sunglasses");}
  // Snow
  if(day.wcode>=71&&day.wcode<=77){g.essential.push("Gaiters","Traction devices");g.recommended.push("Trekking poles");}
  // Thunderstorms
  if(day.wcode>=95){g.essential.push("Emergency shelter/bivy");g.recommended.push("Lightning safety knowledge");}
  // General
  g.recommended.push("First aid kit","Headlamp");
  g.optional.push("Trekking poles","Camera","Emergency whistle","Sit pad");
  return g;
}

function renderGearChecklist(day){
  var g=buildGearList(day);
  var html='<div class="icd"><h4>ğŸ’ Gear Checklist</h4>';
  html+='<div style="font-size:11px;color:var(--txmu);margin-bottom:8px">Based on today\'s conditions. Beyond your usual kit:</div>';
  if(g.essential.length){html+='<div style="font-size:11px;font-weight:600;color:#8b4513;margin-bottom:4px">ESSENTIAL</div><div class="gear-list">'+g.essential.map(function(i){return'<span class="gear-item essential">'+esc(i)+'</span>';}).join("")+'</div>';}
  if(g.recommended.length){html+='<div style="font-size:11px;font-weight:600;color:#4a7c59;margin:8px 0 4px">RECOMMENDED</div><div class="gear-list">'+g.recommended.map(function(i){return'<span class="gear-item recommended">'+esc(i)+'</span>';}).join("")+'</div>';}
  if(g.optional.length){html+='<div style="font-size:11px;font-weight:600;color:var(--txmu);margin:8px 0 4px">OPTIONAL</div><div class="gear-list">'+g.optional.map(function(i){return'<span class="gear-item optional">'+esc(i)+'</span>';}).join("")+'</div>';}
  html+='</div>';return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Elevation-Adjusted Weather
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var elevGain=2500,elevOn=false;
function elevAdj(day){
  if(!elevOn||!elevGain)return null;
  var lapse=3.5*(elevGain/1000);// Â°F per 1000ft
  var windMult=1+0.3*(elevGain/2000);// rough wind increase
  return{
    tmax:Math.round(day.tmax-lapse),tmin:Math.round(day.tmin-lapse),
    atmax:Math.round(day.atmax-lapse-2),// wind chill adds ~2Â°F
    wmax:Math.round(day.wmax*windMult),gmax:Math.round(day.gmax*windMult),
    uvmax:+(day.uvmax*(1+0.06*(elevGain/1000))).toFixed(1)// ~6% UV increase per 1000ft
  };
}
function renderElevBar(day){
  var adj=elevAdj(day);
  var html='<div class="elev-bar"><label>â›°ï¸ Summit Estimate</label><div class="elev-toggle'+(elevOn?" on":"")+'" onclick="elevOn=!elevOn;renderDetail()"></div>';
  if(elevOn){
    html+='<span>Elev gain:</span><input type="number" value="'+elevGain+'" step="500" min="500" max="8000" onchange="elevGain=parseInt(this.value)||2500;renderDetail()">';
    html+='<span>ft</span>';
    if(adj)html+='<div class="elev-note">At summit: ~'+adj.tmax+'Â°/'+adj.tmin+'Â°F, feels '+adj.atmax+'Â°F, wind '+adj.wmax+' mph (gusts '+adj.gmax+'), UV '+adj.uvmax+'</div>';
  }else{
    html+='<span style="color:var(--txmu);font-size:11px">Toggle to see estimated ridgeline conditions</span>';
  }
  html+='</div>';return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Share Trip Plan
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildShareText(){
  if(!tripPlan||!tripPlan.days||!tripPlan.days.length)return null;
  var lines=["ğŸ¥¾ HIKING TRIP PLAN â€” "+curLoc.name,""];
  if(tripPlan.overview)lines.push(tripPlan.overview.replace(/<[^>]+>/g,""),"");
  tripPlan.days.forEach(function(day){
    var wxDay=wxDays[day.dayIndex];
    lines.push("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    lines.push("ğŸ“… "+day.dayLabel);
    if(wxDay)lines.push("ğŸŒ¤ï¸ "+Math.round(wxDay.tmax)+"Â°/"+Math.round(wxDay.tmin)+"Â°F Â· "+(WMO[wxDay.wcode]||"")+" Â· Score: "+wxDay.hike.score+"/100 Â· "+wxDay.win);
    if(day.advice)lines.push("",day.advice.replace(/<[^>]+>/g,""));
    if(day.trails&&day.trails.length){
      lines.push("");
      day.trails.forEach(function(t){
        var info=t.name;
        if(t.distance)info+=" Â· "+t.distance;if(t.elevation)info+=" Â· "+t.elevation;if(t.difficulty)info+=" ("+t.difficulty+")";
        if(t.crowdLevel)info+=" Â· Crowds: "+t.crowdLevel;
        if(t.driveTime)info+=" Â· ğŸš— "+t.driveTime;
        lines.push("  ğŸ¥¾ "+info);
        if(t.why)lines.push("     "+t.why);
        var sn=t.alltrails||t.name+" "+curLoc.name;
        lines.push("     AllTrails: https://www.google.com/search?q="+encodeURIComponent(sn+" alltrails"));
      });
    }
    lines.push("");
  });
  lines.push("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
  lines.push("Generated by Trail Weather Advisor");
  lines.push("https://altrugold.github.io/Trail-Weather-/");
  return lines.join("\n");
}

function shareTripPlan(){
  var text=buildShareText();
  if(!text){alert("No trip plan to share. Build one first.");return;}
  if(navigator.share){
    navigator.share({title:"Hiking Trip Plan â€” "+curLoc.name,text:text}).catch(function(){});
  }else{
    navigator.clipboard.writeText(text).then(function(){
      var btn=document.getElementById("sharebtn");
      if(btn){btn.textContent="âœ“ Copied!";setTimeout(function(){btn.textContent="ğŸ“¤ Share Plan";},2000);}
    }).catch(function(){
      // Fallback: select all in a textarea
      var ta=document.createElement("textarea");ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand("copy");document.body.removeChild(ta);
      var btn=document.getElementById("sharebtn");
      if(btn){btn.textContent="âœ“ Copied!";setTimeout(function(){btn.textContent="ğŸ“¤ Share Plan";},2000);}
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Render Day Detail
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDetail(){
  var day=wxDays[selIdx],tips=getTips(day),el=document.getElementById("ddet");
  var precipStat=day.pprob+"% chance";if(day.psum>0)precipStat+=" Â· "+day.psum+'" expected';
  var stats=[["High / Low",Math.round(day.tmax)+"Â° / "+Math.round(day.tmin)+"Â°F"],["Feels Like",Math.round(day.atmax)+"Â°F"],["Precipitation",precipStat],["Wind",Math.round(day.wmax)+" mph, gusts "+Math.round(day.gmax)],["UV Index",(day.uvmax||0).toFixed(1)],["Sun",day.sr+" â€“ "+day.ss]];
  var winH=day.win?'<div class="wbn"><strong>â° Best Hiking Window: </strong>'+day.win+'</div>':"";
  var posH=day.hike.positives.length?'<div style="margin-bottom:8px;display:flex;flex-wrap:wrap;gap:4px">'+day.hike.positives.map(function(p){return'<span class="pt">âœ“ '+p+'</span>';}).join("")+'</div>':"";
  var issH=day.hike.issues.length?'<div style="margin-bottom:10px">'+day.hike.issues.map(function(s){return'<div class="iss">âš  '+s+'</div>';}).join("")+'</div>':"";
  var tipH=tips.map(function(t){return'<p class="tip">'+t+'</p>';}).join("");

  var cached=aiCache[selIdx],aiH;
  if(cached){
    aiH='<div class="aiout">'+formatAI(cached.assessment)+'</div>';
    if(cached.trails&&cached.trails.length)aiH+=renderTrailsInline(cached.trails);
    aiH+=renderDayChatUI();
  }else if(!apiKey){
    aiH='<p style="font-size:12px;color:var(--txmu);margin:6px 0 0">Add your API key in âš™ï¸ Settings for AI recommendations.</p>';
  }else{
    aiH='<button class="aibtn" id="aibtn" onclick="runAI()">Get AI Advice for '+esc(curLoc.name)+'</button><p style="font-size:11.5px;color:var(--txmu);margin-top:6px">Single-day trail recommendations. Use Trip Planner above for multi-day planning.</p>';
  }

  var hrows=day.hrs.map(function(hr){
    var t=new Date(hr.time);var h=t.getHours();var lbl=h===0?"12 AM":h<12?h+" AM":h===12?"12 PM":(h-12)+" PM";var ni=h<6||h>20?" ni":"";
    return'<div class="hrow'+ni+'"><span class="ht2">'+lbl+'</span><span style="font-size:14px">'+wI(hr.wc)+'</span><span>'+Math.round(hr.t)+'Â°F</span><span style="color:'+(hr.pp>40?"var(--dng)":"var(--txmu)")+'">'+hr.pp+'%'+(hr.pr>0?' Â· '+hr.pr.toFixed(2)+'"':'')+'</span><span style="color:'+(hr.ws>20?"var(--dng)":"var(--txmu)")+'">ğŸ’¨ '+Math.round(hr.ws)+'</span><span style="color:'+((hr.uv||0)>6?"var(--dng)":"var(--txmu)")+'">'+(hr.uv||0).toFixed(1)+'</span><span style="color:var(--txmu)">'+Math.round(hr.rh)+'%</span></div>';
  }).join("");

  el.innerHTML=
    '<div style="display:flex;flex-wrap:wrap;gap:16px;margin-bottom:20px"><div style="flex:1 1 260px"><div style="display:flex;align-items:center;gap:12px;margin-bottom:10px"><span style="font-size:40px">'+wI(day.wcode)+'</span><div><h3 style="font-family:var(--sf);font-size:22px;font-weight:700">'+day.disp+'</h3><div style="font-size:12.5px;color:var(--txmu)">'+(WMO[day.wcode]||"")+(day.trend!=="steady"?' Â· <span style="color:'+(day.trend==="improving"?"#4a7c59":"#c45a3c")+'">'+(day.trend==="improving"?"â†— Improving":"â†˜ Worsening")+'</span>':'')+'</div></div></div>'+scbHTML(day.hike,true)+'</div><div style="flex:1 1 220px;display:grid;grid-template-columns:1fr 1fr;gap:7px 18px;font-size:13px">'+stats.map(function(s){return'<div><div style="color:var(--txmu);font-size:10px;text-transform:uppercase;letter-spacing:.6px">'+s[0]+'</div><div style="color:var(--tx);font-weight:500;margin-top:1px">'+s[1]+'</div></div>';}).join("")+'</div></div>'+
    winH+renderElevBar(day)+
    '<div class="icd"><h4>Trail Conditions Assessment</h4>'+posH+issH+'<div class="divr">'+tipH+'</div></div>'+
    renderGearChecklist(day)+
    '<div class="icd"><h4 style="margin-bottom:'+(cached?'12':'10')+'px">ğŸ¤– AI Trail Advisor</h4>'+aiH+'</div>'+
    '<div class="hw"><h4>Hourly Breakdown</h4><div class="hs"><div class="htbl"><div class="hh"><span>Time</span><span></span><span>Temp</span><span>Rain</span><span>Wind</span><span>UV</span><span>Humid</span></div><div class="hbd">'+hrows+'</div></div></div></div>';
}

function formatAI(text){return text.split("\n\n").map(function(p){p=p.trim();if(!p)return"";return"<p>"+esc(p).replace(/\n/g,"<br>")+"</p>";}).join("");}

function renderTrailsInline(trails){
  if(!trails||!trails.length)return"";
  var loc=curLoc?curLoc.name:"";
  return'<div style="margin-top:10px"><div style="font-weight:700;font-size:13px;margin-bottom:6px">ğŸ¥¾ Suggested Trails</div>'+
    trails.map(function(t){
      var stats=[];if(t.distance)stats.push(t.distance);if(t.elevation)stats.push(t.elevation);if(t.difficulty)stats.push(t.difficulty);
      if(t.driveTime)stats.push("ğŸš— "+t.driveTime);
      var crowdBadge="";
      if(t.crowdLevel){var cc=t.crowdLevel.toLowerCase();var col=cc==="low"?"#4a7c59":cc==="moderate"?"#b8860b":"#c45a3c";crowdBadge=' <span style="font-size:10px;font-weight:600;color:'+col+';border:1px solid '+col+'30;border-radius:4px;padding:1px 6px;margin-left:6px">ğŸ‘¥ '+esc(t.crowdLevel)+'</span>';}
      var sn=t.alltrails||t.name+" "+loc;
      var links='<div class="trl-links"><a href="https://www.google.com/search?q='+encodeURIComponent(sn+" alltrails")+'" target="_blank" rel="noopener">AllTrails â†—</a><a href="https://www.google.com/search?q='+encodeURIComponent(t.name+" hiking trail "+loc)+'" target="_blank" rel="noopener">Google â†—</a>';
      if(t.webUrl)links+='<a href="'+esc(t.webUrl)+'" target="_blank" rel="noopener">Info â†—</a>';links+='</div>';
      return'<div class="trl-item"><div class="trl-name">'+esc(t.name)+crowdBadge+'</div>'+(stats.length?'<div class="trl-stats">'+esc(stats.join(" Â· "))+'</div>':'')+(t.why?'<div class="trl-why">'+esc(t.why)+'</div>':'')+links+'</div>';
    }).join("")+'</div>';
}

function renderDayChatUI(){
  var msgs=chatHistory[selIdx]||[];var followUps=msgs.slice(2);var h="";
  if(followUps.length){
    h='<div class="chat-msgs" id="chatmsgs">';
    followUps.forEach(function(m){h+=m.role==="user"?'<div class="chat-msg user">'+esc(m.content)+'</div>':'<div class="chat-msg ai">'+formatAI(m.content)+'</div>';});
    h+='</div>';
  }
  return h+'<div class="chat-input-row"><textarea class="chat-input" id="chatinput" placeholder="Ask about these trails, request different options..." rows="1" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();handleDayChat();}"></textarea><button class="chat-send" id="chatsend" onclick="handleDayChat()">Send</button></div>';
}

function handleDayChat(){
  var input=document.getElementById("chatinput"),btn=document.getElementById("chatsend");
  var msg=input.value.trim();if(!msg||!apiKey)return;
  input.value="";input.disabled=true;btn.disabled=true;btn.textContent="...";
  var container=document.getElementById("chatmsgs");
  if(!container){var row=input.closest(".chat-input-row");container=document.createElement("div");container.className="chat-msgs";container.id="chatmsgs";row.parentNode.insertBefore(container,row);}
  container.innerHTML+='<div class="chat-msg user">'+esc(msg)+'</div><div class="chat-msg ai" id="chatloading" style="color:var(--txmu)">Thinking...</div>';
  container.scrollTop=container.scrollHeight;
  sendDayChat(msg).then(function(text){
    var l=document.getElementById("chatloading");if(l)l.outerHTML='<div class="chat-msg ai">'+formatAI(text)+'</div>';
    input.disabled=false;btn.disabled=false;btn.textContent="Send";input.focus();
    var c=document.getElementById("chatmsgs");if(c)c.scrollTop=c.scrollHeight;
  }).catch(function(e){
    var l=document.getElementById("chatloading");if(l)l.outerHTML='<div class="chat-msg ai" style="color:var(--dng)">Error: '+esc(e.message)+'</div>';
    input.disabled=false;btn.disabled=false;btn.textContent="Send";
  });
}

function runAI(){
  var btn=document.getElementById("aibtn");if(btn){btn.disabled=true;btn.textContent="Analyzing conditions...";}
  callAI(wxDays[selIdx],curLoc.name).then(function(r){if(r){aiCache[selIdx]=r;}renderDetail();}).catch(function(e){
    var b=document.getElementById("aibtn");if(b){b.disabled=false;b.textContent="Retry";}
    var p=b?b.parentElement:null;if(p){var err=document.createElement("div");err.style.cssText="font-size:12.5px;color:var(--dng);margin-top:8px";err.textContent=e.message;p.appendChild(err);}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init(){
  try{apiKey=localStorage.getItem("twx-key")||"";}catch(e){}
  updateKeyBanner();
  document.getElementById("pgr").innerHTML=PRESETS.map(function(p,i){
    return'<div class="pcd" onclick="selectLoc(PRESETS['+i+'])"><div class="pn">â›°ï¸ '+esc(p.name)+'</div><div class="pr">'+esc(p.admin1)+', '+esc(p.country)+'</div></div>';
  }).join("");
  loadFavs();
}
init();
</script>
</body>
</html>
